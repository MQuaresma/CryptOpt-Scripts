#!/usr/bin/env bash
# vim: set syntax=bash:

# Who is wilson? Better watch 'Cast away' tonight

#singleton (Start)
umask 000                  # allow all users to access the file we're about to create
exec 9>"/tmp/${0##*/}.lck" # open lockfile on FD 9, based on basename of argv[0]
umask 022                  # move back to more restrictive file permissions
flock -x -n 9 || exit      # grab that lock, or exit the script early
#singleton (end)

sleeptime="{{ sleeptime | default (60) }}"
IFS=' ' read -ra curves <<<"{{ curves | default('curve25519') }}"
for curve in "${curves[@]}"; do
  for method in square mul; do
    while
      echo sleeping
      sleep ${sleeptime}
      pgrep node -U $UID
    do :; done
    sed -i -e "s/--method [^ ]*/--method ${method}/" -e "s/--curve [^ ]*/--curve ${curve}/" ~/session.mux
    ~/session.mux cryptopt &
    echo start $func $curve
  done
done
